<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Book Appointment - DR T DENTAL</title>
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-64X2PHHQJD"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-64X2PHHQJD');
  </script>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  <style>
    :root {
      --bg: #ffffff;
      --text: #333333;
      --card-bg: #f8f8f8;
      --accent: #009688;
    }

    [data-theme="dark"] {
      --bg: #121212;
      --text: #e0e0e0;
      --card-bg: #1f1f1f;
    }

    body {
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s ease, color 0.3s ease;
    }

    .appointment-hero {
      background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), 
                  url('https://www.evdp.net/wp-content/uploads/2023/08/How-to-Book-Your-Dental-Appointment-Online-at-East-Valley-Dental-Professionals-FIMG.jpg') center/cover;
      color: white;
      padding: 6rem 0;
      text-align: center;
    }

    .booking-card {
      background: var(--bg);
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }

    .booking-card:hover {
      transform: translateY(-5px);
    }

    .service-option {
      background: var(--card-bg);
      border: 2px solid transparent;
      border-radius: 10px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .service-option:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }

    .service-option.selected {
      border-color: var(--accent);
      background: rgba(0, 150, 136, 0.1);
    }

    .service-icon {
      font-size: 2rem;
      color: var(--accent);
      margin-bottom: 1rem;
    }

    .form-control {
      background: var(--bg);
      border: 2px solid var(--card-bg);
      color: var(--text);
      border-radius: 10px;
      padding: 0.75rem 1rem;
      transition: all 0.3s ease;
    }

    .form-control:focus {
      background: var(--bg);
      border-color: var(--accent);
      color: var(--text);
      box-shadow: 0 0 0 0.2rem rgba(0, 150, 136, 0.25);
    }

    .form-control::placeholder {
      color: var(--text);
      opacity: 0.6;
    }

    .btn-primary {
      background: var(--accent);
      border: none;
      border-radius: 10px;
      padding: 0.75rem 2rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      background: #00796b;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .booking-steps {
      background: var(--accent);
      color: white;
      padding: 2rem 0;
      margin-bottom: 3rem;
    }

    .step-item {
      text-align: center;
      position: relative;
    }

    .step-number {
      width: 50px;
      height: 50px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1rem;
      font-weight: bold;
      font-size: 1.2rem;
    }

    .step-item.active .step-number {
      background: white;
      color: var(--accent);
    }

    .step-item.hidden {
      display: none;
    }

    .step-line {
      position: absolute;
      top: 25px;
      left: 60%;
      width: 80%;
      height: 2px;
      background: rgba(255, 255, 255, 0.3);
      z-index: 1;
    }

    .step-item:last-child .step-line {
      display: none;
    }

    .insurance-info {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .insurance-icon {
      font-size: 2.5rem;
      color: var(--accent);
      margin-bottom: 1rem;
    }

    .payment-options {
      background: var(--bg);
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 2rem;
      border: 2px solid var(--accent);
    }

    .payment-icon {
      font-size: 2rem;
      color: var(--accent);
      margin-right: 0.5rem;
    }

    .book-now-btn {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: var(--accent);
      color: white;
      padding: 1rem 2rem;
      border-radius: 50px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      transition: transform 0.3s ease;
      text-decoration: none;
    }

    .book-now-btn:hover {
      transform: translateY(-5px);
      color: white;
    }

    .progress-bar {
      height: 8px;
      background: var(--card-bg);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 2rem;
    }

    .progress-fill {
      height: 100%;
      background: var(--accent);
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
    <div class="container">
      <a class="navbar-brand" href="index.html">DR T DENTAL</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="services.html">Services</a></li>
          <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
          <li class="nav-item"><a class="nav-link" href="testimonials.html">Testimonials</a></li>
          <li class="nav-item"><a class="nav-link" href="blog.html">Blog</a></li>
          <li class="nav-item"><a class="nav-link" href="patient-portal.html">Patient Portal</a></li>
          <li class="nav-item"><a class="nav-link" href="payment.html">Payment</a></li>
          <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
          <li class="nav-item">
            <button id="themeToggle" class="btn btn-outline-light ms-3">ðŸŒ™</button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Appointment Hero -->
  <section class="appointment-hero">
    <div class="container">
      <h1 class="display-4 fw-bold mb-4">Book Your Appointment</h1>
      <p class="lead">Take the first step towards your perfect smile. Book your consultation today!</p>
    </div>
  </section>

  <!-- Booking Steps -->
  <section class="booking-steps">
    <div class="container">
      <div class="row">
        <div class="col-md-3">
          <div class="step-item active">
            <div class="step-number">1</div>
            <h6>Select Service</h6>
            <div class="step-line"></div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="step-item">
            <div class="step-number">2</div>
            <h6>Choose Date & Time</h6>
            <div class="step-line"></div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="step-item">
            <div class="step-number">3</div>
            <h6>Patient Information</h6>
            <div class="step-line"></div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="step-item">
            <div class="step-number">4</div>
            <h6>Confirmation</h6>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Progress Bar -->
  <section class="py-3">
    <div class="container">
      <div class="progress-bar">
        <div class="progress-fill" id="progressBar" style="width: 25%"></div>
      </div>
    </div>
  </section>

  <!-- Appointment Form -->
  <section class="py-5">
    <div class="container">
      <form id="appointmentForm">
        <!-- Step 1: Service Selection -->
        <div class="booking-step" id="step1">
          <div class="row">
            <div class="col-lg-8">
              <div class="booking-card">
                <h3 class="mb-4">What service do you need?</h3>
                <div class="row g-3">
                  <div class="col-md-6">
                    <div class="service-option" data-service="consultation">
                      <i class="fas fa-user-md service-icon"></i>
                      <h5>Free Consultation</h5>
                      <p>Initial examination and treatment planning</p>
                      <small class="text-muted">Duration: 30 minutes</small>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="service-option" data-service="cleaning">
                      <i class="fas fa-tooth service-icon"></i>
                      <h5>Teeth Cleaning</h5>
                      <p>Professional cleaning and examination</p>
                      <small class="text-muted">Duration: 45 minutes</small>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="service-option" data-service="whitening">
                      <i class="fas fa-sun service-icon"></i>
                      <h5>Teeth Whitening</h5>
                      <p>Professional in-office whitening</p>
                      <small class="text-muted">Duration: 1 hour</small>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="service-option" data-service="emergency">
                      <i class="fas fa-exclamation-triangle service-icon"></i>
                      <h5>Emergency Care</h5>
                      <p>Urgent dental treatment</p>
                      <small class="text-muted">Duration: Varies</small>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="service-option" data-service="orthodontics">
                      <i class="fas fa-align-center service-icon"></i>
                      <h5>Orthodontics</h5>
                      <p>Braces and alignment consultation</p>
                      <small class="text-muted">Duration: 1 hour</small>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="service-option" data-service="implants">
                      <i class="fas fa-screwdriver service-icon"></i>
                      <h5>Dental Implants</h5>
                      <p>Implant consultation and planning</p>
                      <small class="text-muted">Duration: 1 hour</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="insurance-info">
                <i class="fas fa-shield-alt insurance-icon"></i>
                <h4>Insurance & Payment</h4>
                <p>We accept most insurance plans and offer flexible payment options.</p>
                <ul class="list-unstyled">
                  <li><i class="fas fa-check text-success me-2"></i>Most insurance accepted</li>
                  <li><i class="fas fa-check text-success me-2"></i>Flexible payment plans</li>
                  <li><i class="fas fa-check text-success me-2"></i>CareCredit financing</li>
                  <li><i class="fas fa-check text-success me-2"></i>Credit/debit cards</li>
                </ul>
                <a href="contact.html" class="btn btn-outline-primary mt-3">Learn More</a>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 2: Date & Time Selection -->
        <div class="booking-step" id="step2" style="display: none;">
          <div class="row">
            <div class="col-lg-8">
              <div class="booking-card">
                <h3 class="mb-4">When would you like to visit?</h3>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="appointmentDate" class="form-label">Preferred Date *</label>
                    <input type="date" class="form-control" id="appointmentDate" name="appointmentDate" required>
                  </div>
                  <div class="col-md-6">
                    <label for="appointmentTime" class="form-label">Preferred Time *</label>
                    <select class="form-control" id="appointmentTime" name="appointmentTime" required>
                      <option value="">Select time</option>
                      <option value="09:00">9:00 AM</option>
                      <option value="10:00">10:00 AM</option>
                      <option value="11:00">11:00 AM</option>
                      <option value="12:00">12:00 PM</option>
                      <option value="14:00">2:00 PM</option>
                      <option value="15:00">3:00 PM</option>
                      <option value="16:00">4:00 PM</option>
                      <option value="17:00">5:00 PM</option>
                    </select>
                  </div>
                  <div class="col-12">
                    <label for="notes" class="form-label">Additional Notes</label>
                    <textarea class="form-control" id="notes" name="notes" rows="3" 
                              placeholder="Any specific concerns or requests..."></textarea>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="payment-options">
                <h4><i class="fas fa-credit-card payment-icon"></i>Payment Options</h4>
                <p>Choose how you'd like to pay for your treatment: <span class="text-danger">*</span></p>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="radio" name="paymentMethod" id="insurance" value="insurance">
                  <label class="form-check-label" for="insurance">Use Insurance</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="paymentMethod" id="onlineCredit" value="onlineCredit">
                  <label class="form-check-label" for="onlineCredit">Online Credit</label>
                </div>
                <small class="text-muted d-block mt-2"><span class="text-danger">*</span> Required</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3: Patient Information -->
        <div class="booking-step" id="step3" style="display: none;">
          <div class="row">
            <div class="col-lg-8">
              <div class="booking-card">
                <h3 class="mb-4">Tell us about yourself</h3>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="firstName" class="form-label">First Name *</label>
                    <input type="text" class="form-control" id="firstName" name="firstName" required>
                  </div>
                  <div class="col-md-6">
                    <label for="lastName" class="form-label">Last Name *</label>
                    <input type="text" class="form-control" id="lastName" name="lastName" required>
                  </div>
                  <div class="col-md-6">
                    <label for="email" class="form-label">Email Address *</label>
                    <input type="email" class="form-control" id="email" name="email" required>
                  </div>
                  <div class="col-md-6">
                    <label for="phone" class="form-label">Phone Number *</label>
                    <input type="tel" class="form-control" id="phone" name="phone" required>
                  </div>
                  <div class="col-md-6">
                    <label for="dateOfBirth" class="form-label">Date of Birth</label>
                    <input type="date" class="form-control" id="dateOfBirth" name="dateOfBirth">
                  </div>
                  <div class="col-md-6">
                    <label for="gender" class="form-label">Gender</label>
                    <select class="form-control" id="gender" name="gender">
                      <option value="">Select gender</option>
                      <option value="male">Male</option>
                      <option value="female">Female</option>
                      <option value="other">Other</option>
                      <option value="prefer-not">Prefer not to say</option>
                    </select>
                  </div>
                  <div class="col-12">
                    <label for="address" class="form-label">Address</label>
                    <textarea class="form-control" id="address" name="address" rows="2" 
                              placeholder="Street address, city, postal code"></textarea>
                  </div>
                  <div class="col-md-6">
                    <label for="emergencyContact" class="form-label">Emergency Contact</label>
                    <input type="text" class="form-control" id="emergencyContact" name="emergencyContact" 
                           placeholder="Name and relationship">
                  </div>
                  <div class="col-md-6">
                    <label for="emergencyPhone" class="form-label">Emergency Phone</label>
                    <input type="tel" class="form-control" id="emergencyPhone" name="emergencyPhone">
                  </div>
                  <div class="col-12">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="newPatient" name="newPatient">
                      <label class="form-check-label" for="newPatient">
                        I am a new patient
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="insurance-info">
                <h4>Insurance Information</h4>
                <p>If you have dental insurance, please provide the following details:</p>
                <div class="mb-3">
                  <label for="insuranceProvider" class="form-label">Insurance Provider</label>
                  <input type="text" class="form-control" id="insuranceProvider" name="insuranceProvider" 
                         placeholder="e.g., Delta Dental">
                </div>
                <div class="mb-3">
                  <label for="memberId" class="form-label">Member ID</label>
                  <input type="text" class="form-control" id="memberId" name="memberId">
                </div>
                <div class="mb-3">
                  <label for="groupNumber" class="form-label">Group Number</label>
                  <input type="text" class="form-control" id="groupNumber" name="groupNumber">
                </div>
                <p class="small text-muted">* Insurance information is optional but helps us provide better service</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 4: Confirmation -->
        <div class="booking-step" id="step4" style="display: none;">
          <div class="row">
            <div class="col-lg-8">
              <div class="booking-card">
                <h3 class="mb-4">Review Your Appointment</h3>
                <div id="appointmentSummary">
                  <!-- Summary will be populated by JavaScript -->
                </div>
                <div class="mt-4">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="termsConsent" name="termsConsent" required>
                    <label class="form-check-label" for="termsConsent">
                      I agree to the <a href="#" target="_blank">terms and conditions</a> and 
                      <a href="#" target="_blank">privacy policy</a> *
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="marketingConsent" name="marketingConsent">
                    <label class="form-check-label" for="marketingConsent">
                      I would like to receive updates about dental health tips and special offers
                    </label>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="insurance-info">
                <h4>What to Expect</h4>
                <ul class="list-unstyled">
                  <li><i class="fas fa-clock text-primary me-2"></i>Confirmation email within 1 hour</li>
                  <li><i class="fas fa-phone text-primary me-2"></i>Follow-up call within 24 hours</li>
                  <li><i class="fas fa-file-alt text-primary me-2"></i>Pre-appointment forms sent</li>
                  <li><i class="fas fa-map-marker-alt text-primary me-2"></i>Directions to our office</li>
                </ul>
                <div class="alert alert-info">
                  <i class="fas fa-info-circle me-2"></i>
                  <strong>Need to reschedule?</strong> Call us at least 24 hours in advance.
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="row mt-4">
          <div class="col-12 text-center">
            <button type="button" class="btn btn-secondary btn-lg me-3" id="prevBtn" style="display: none;">
              <i class="fas fa-arrow-left me-2"></i>Previous
            </button>
            <button type="button" class="btn btn-primary btn-lg" id="nextBtn">
              Next<i class="fas fa-arrow-right ms-2"></i>
            </button>
            <button type="submit" class="btn btn-success btn-lg" id="submitBtn" style="display: none;">
              <i class="fas fa-check me-2"></i>Confirm Appointment
            </button>
          </div>
        </div>
      </form>
    </div>
  </section>

  <!-- Book Now Button -->
  <a href="contact.html" class="book-now-btn">
    <i class="fas fa-phone me-2"></i>Call Us
  </a>

  <!-- Footer -->
  <footer class="py-4" style="background: var(--card-bg);">
    <div class="container text-center">
      <p class="mb-0">&copy; 2025 DR T DENTAL. All rights reserved.</p>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="api-integration.js"></script>
  <script>
    // Require authentication before using the booking flow
    (function enforceAuthGate() {
      try {
        if (!window.DentalFrontend || !window.DentalFrontend.requireAuth) return;
        // Save intent so we can return after login
        sessionStorage.setItem('postLoginRedirect', 'appointment.html');
        if (!DentalFrontend.requireAuth('appointment.html')) {
          return; // redirected
        }
      } catch (_) {}
    })();

    // Auto-fill patient data if logged in and hide step 3 for existing patients
    async function autoFillPatientData() {
      try {
        // Check if user is authenticated
        if (!window.DentalFrontend || !DentalFrontend.isAuthenticated()) {
          return; // Not logged in, skip auto-fill
        }

        // Get current patient data
        const response = await DentalAPI.getCurrentPatient();
        
        if (response && response.success && response.data) {
          const patient = response.data;
          
          // Mark as existing patient
          isExistingPatient = true;
          
          // Hide Step 3 (Patient Information) for existing patients
          const step3Element = document.getElementById('step3');
          if (step3Element) {
            step3Element.style.display = 'none';
          }
          
          // Hide step 3 indicator in navigation
          const step3Indicator = document.querySelector('.step-item:nth-child(3)');
          if (step3Indicator) {
            step3Indicator.classList.add('hidden');
          }
          
          // Adjust total steps
          totalSteps = 3;
          
          // Adjust step 4 to be step 3 visually
          const step4Indicator = document.querySelector('.step-item:nth-child(4)');
          if (step4Indicator) {
            const step4Number = step4Indicator.querySelector('.step-number');
            if (step4Number) {
              step4Number.textContent = '3';
            }
            const step4Label = step4Indicator.querySelector('h6');
            if (step4Label) {
              step4Label.textContent = 'Confirmation';
            }
            // Remove the step line since step 3 is hidden
            const step4Line = step4Indicator.querySelector('.step-line');
            if (step4Line) {
              step4Line.remove();
            }
          }
          
          // Update step labels for better clarity
          const step2Indicator = document.querySelector('.step-item:nth-child(2) .step-number');
          if (step2Indicator) {
            step2Indicator.textContent = '2';
          }
          
          // Fill in patient information fields (Step 3)
          if (patient.first_name) {
            const firstNameField = document.getElementById('firstName');
            if (firstNameField) firstNameField.value = patient.first_name;
          }
          
          if (patient.last_name) {
            const lastNameField = document.getElementById('lastName');
            if (lastNameField) lastNameField.value = patient.last_name;
          }
          
          if (patient.email) {
            const emailField = document.getElementById('email');
            if (emailField) emailField.value = patient.email;
          }
          
          if (patient.phone) {
            const phoneField = document.getElementById('phone');
            if (phoneField) phoneField.value = patient.phone;
          }
          
          if (patient.date_of_birth) {
            const dobField = document.getElementById('dateOfBirth');
            if (dobField) dobField.value = patient.date_of_birth;
          }
          
          if (patient.gender) {
            const genderField = document.getElementById('gender');
            if (genderField) genderField.value = patient.gender;
          }
          
          // Build address string from components
          if (patient.street_address || patient.city || patient.postal_code) {
            const addressParts = [];
            if (patient.street_address) addressParts.push(patient.street_address);
            if (patient.city) addressParts.push(patient.city);
            if (patient.postal_code) addressParts.push(patient.postal_code);
            if (patient.country) addressParts.push(patient.country);
            
            const addressField = document.getElementById('address');
            if (addressField && addressParts.length > 0) {
              addressField.value = addressParts.join(', ');
            }
          }
          
          // Emergency contact
          if (patient.emergency_contact_name) {
            const emergencyContactField = document.getElementById('emergencyContact');
            if (emergencyContactField) {
              let contactValue = patient.emergency_contact_name;
              if (patient.emergency_contact_relationship) {
                contactValue += ` (${patient.emergency_contact_relationship})`;
              }
              emergencyContactField.value = contactValue;
            }
          }
          
          if (patient.emergency_contact_phone) {
            const emergencyPhoneField = document.getElementById('emergencyPhone');
            if (emergencyPhoneField) emergencyPhoneField.value = patient.emergency_contact_phone;
          }
          
          // Insurance information
          if (patient.insurance_provider) {
            const insuranceProviderField = document.getElementById('insuranceProvider');
            if (insuranceProviderField) insuranceProviderField.value = patient.insurance_provider;
          }
          
          if (patient.insurance_member_id) {
            const memberIdField = document.getElementById('memberId');
            if (memberIdField) memberIdField.value = patient.insurance_member_id;
          }
          
          if (patient.insurance_group_number) {
            const groupNumberField = document.getElementById('groupNumber');
            if (groupNumberField) groupNumberField.value = patient.insurance_group_number;
          }
          
          // Set new patient checkbox based on whether patient exists
          const newPatientCheckbox = document.getElementById('newPatient');
          if (newPatientCheckbox) {
            newPatientCheckbox.checked = false; // Existing patient
          }
          
          console.log('Patient data auto-filled successfully');
        }
      } catch (error) {
        console.warn('Could not auto-fill patient data:', error);
        // Don't show error to user, just silently fail - they can still fill manually
      }
    }

    // Call auto-fill when page loads and initialize step visibility
    document.addEventListener('DOMContentLoaded', function() {
      // Wait a bit for API integration to be ready
      setTimeout(async () => {
        await autoFillPatientData();
        // Update progress bar initial state
        updateProgress();
      }, 500);
    });
    // Theme toggle functionality
    const toggleBtn = document.getElementById('themeToggle');
    const htmlEl = document.documentElement;

    toggleBtn.addEventListener('click', () => {
      const currentTheme = htmlEl.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      htmlEl.setAttribute('data-theme', newTheme);
      toggleBtn.textContent = newTheme === 'light' ? 'ðŸŒ™' : 'â˜€ï¸';
    });

    // Appointment booking functionality
    let currentStep = 1;
    let totalSteps = 4;
    let isExistingPatient = false;

    // Service selection
    document.querySelectorAll('.service-option').forEach(option => {
      option.addEventListener('click', function() {
        document.querySelectorAll('.service-option').forEach(opt => opt.classList.remove('selected'));
        this.classList.add('selected');
      });
    });

    // Navigation
    document.getElementById('nextBtn').addEventListener('click', nextStep);
    document.getElementById('prevBtn').addEventListener('click', prevStep);

    function nextStep() {
      if (validateCurrentStep()) {
        if (currentStep < totalSteps) {
          document.getElementById(`step${currentStep}`).style.display = 'none';
          currentStep++;
          
          // Skip step 3 if existing patient
          if (isExistingPatient && currentStep === 3) {
            currentStep = 4; // Jump directly to confirmation
          }
          
          document.getElementById(`step${currentStep}`).style.display = 'block';
          updateProgress();
          updateNavigation();
        }
      }
    }

    function prevStep() {
      if (currentStep > 1) {
        document.getElementById(`step${currentStep}`).style.display = 'none';
        currentStep--;
        
        // Skip step 3 if existing patient
        if (isExistingPatient && currentStep === 3) {
          currentStep = 2; // Go back to step 2
        }
        
        document.getElementById(`step${currentStep}`).style.display = 'block';
        updateProgress();
        updateNavigation();
      }
    }

    function updateProgress() {
      // Calculate progress based on current step and total steps
      const progress = (currentStep / (isExistingPatient ? 3 : 4)) * 100;
      document.getElementById('progressBar').style.width = progress + '%';
      
      // Update step indicators
      document.querySelectorAll('.step-item').forEach((item, index) => {
        // Skip step 3 indicator if existing patient
        if (isExistingPatient && index === 2) {
          item.classList.remove('active');
          return; // Skip step 3 indicator
        }
        
        // For existing patients, step 4 (index 3) should activate when on step 4
        // For new patients, each step activates normally
        let shouldBeActive = false;
        
        if (isExistingPatient) {
          // Step 1 (index 0): active when currentStep >= 1
          // Step 2 (index 1): active when currentStep >= 2
          // Step 3 (index 2): skip (hidden)
          // Step 4 (index 3): active when currentStep >= 4 (but shown as step 3)
          if (index === 0 && currentStep >= 1) shouldBeActive = true;
          else if (index === 1 && currentStep >= 2) shouldBeActive = true;
          else if (index === 3 && currentStep >= 4) shouldBeActive = true;
        } else {
          // Normal flow for new patients
          if (index + 1 <= currentStep) shouldBeActive = true;
        }
        
        if (shouldBeActive) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
    }

    function updateNavigation() {
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const submitBtn = document.getElementById('submitBtn');

      if (currentStep === 1) {
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'inline-block';
        submitBtn.style.display = 'none';
      } else if (currentStep === totalSteps || (currentStep === 4 && isExistingPatient)) {
        prevBtn.style.display = 'inline-block';
        nextBtn.style.display = 'none';
        submitBtn.style.display = 'inline-block';
        updateAppointmentSummary();
      } else {
        prevBtn.style.display = 'inline-block';
        nextBtn.style.display = 'inline-block';
        submitBtn.style.display = 'none';
      }
    }

    function validateCurrentStep() {
      if (currentStep === 1) {
        const selectedService = document.querySelector('.service-option.selected');
        if (!selectedService) {
          alert('Please select a service to continue.');
          return false;
        }
      } else if (currentStep === 2) {
        const date = document.getElementById('appointmentDate').value;
        const time = document.getElementById('appointmentTime').value;
        if (!date || !time) {
          alert('Please select both date and time to continue.');
          return false;
        }
      } else if (currentStep === 3 && !isExistingPatient) {
        // Only validate step 3 if it's shown (for new patients)
        const firstName = document.getElementById('firstName').value;
        const lastName = document.getElementById('lastName').value;
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value;
        
        if (!firstName || !lastName || !email || !phone) {
          alert('Please fill in all required fields to continue.');
          return false;
        }
        
        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          alert('Please enter a valid email address.');
          return false;
        }
      } else if (currentStep === 4 || (currentStep === 3 && isExistingPatient)) {
        // Validate terms consent
        if (!document.getElementById('termsConsent').checked) {
          alert('Please agree to the terms and conditions to continue.');
          return false;
        }
        
        // Validate payment method is selected
        const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
        if (!paymentMethod) {
          alert('Please select a payment method before confirming.');
          return false;
        }
      }
      return true;
    }

    function formatDate(dateString) {
      if (!dateString) return 'Not selected';
      const date = new Date(dateString + 'T00:00:00');
      const options = { year: 'numeric', month: 'long', day: 'numeric' };
      return date.toLocaleDateString('en-US', options);
    }

    function formatTime(timeString) {
      if (!timeString) return 'Not selected';
      const [hours, minutes] = timeString.split(':');
      const hour = parseInt(hours);
      const ampm = hour >= 12 ? 'PM' : 'AM';
      const displayHour = hour % 12 || 12;
      return `${displayHour}:${minutes} ${ampm}`;
    }

    function formatPaymentMethod(method) {
      if (!method) return 'Not selected';
      const methods = {
        'insurance': 'Use Insurance',
        'onlineCredit': 'Online Credit'
      };
      return methods[method] || method;
    }

    async function updateAppointmentSummary() {
      const summary = document.getElementById('appointmentSummary');
      const selectedService = document.querySelector('.service-option.selected');
      const date = document.getElementById('appointmentDate').value;
      const time = document.getElementById('appointmentTime').value;
      const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;

      // Get patient information - either from form or from API
      let firstName = document.getElementById('firstName')?.value || '';
      let lastName = document.getElementById('lastName')?.value || '';
      let email = document.getElementById('email')?.value || '';
      let phone = document.getElementById('phone')?.value || '';

      // If existing patient and form fields are empty, get from API
      if (isExistingPatient && (!firstName || !lastName)) {
        try {
          if (window.DentalFrontend && DentalFrontend.isAuthenticated()) {
            const response = await DentalAPI.getCurrentPatient();
            if (response && response.success && response.data) {
              const patient = response.data;
              firstName = patient.first_name || firstName;
              lastName = patient.last_name || lastName;
              email = patient.email || email;
              phone = patient.phone || phone;
            }
          }
        } catch (error) {
          console.warn('Could not fetch patient data for summary:', error);
        }
      }

      summary.innerHTML = `
        <div class="row">
          <div class="col-md-6">
            <h5>Service Details</h5>
            <p><strong>Service:</strong> ${selectedService ? selectedService.querySelector('h5').textContent : 'Not selected'}</p>
            <p><strong>Date:</strong> ${formatDate(date)}</p>
            <p><strong>Time:</strong> ${formatTime(time)}</p>
            <p><strong>Payment Method:</strong> ${formatPaymentMethod(paymentMethod)}</p>
          </div>
          <div class="col-md-6">
            <h5>Patient Information</h5>
            <p><strong>Name:</strong> ${firstName} ${lastName}</p>
            <p><strong>Email:</strong> ${email}</p>
            <p><strong>Phone:</strong> ${phone}</p>
            ${isExistingPatient ? '<p class="text-muted small"><i class="fas fa-check-circle text-success me-1"></i>Using your saved profile information</p>' : ''}
          </div>
        </div>
      `;
    }

    // Form submission -> call backend API
    document.getElementById('appointmentForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const submitBtn = document.getElementById('submitBtn');
      const originalBtnText = submitBtn.innerHTML;

      // Double-check authentication at submit time
      if (!window.DentalFrontend || !DentalFrontend.isAuthenticated()) {
        alert('Please login first in Patient Portal, then try booking again.');
        if (window.DentalFrontend) {
          DentalFrontend.requireAuth('appointment.html');
        } else {
          window.location.href = 'patient-portal.html?redirect=appointment.html';
        }
        return;
      }

      // Validate required fields
      if (!document.getElementById('termsConsent').checked) {
        alert('Please agree to the terms and conditions to continue.');
        return;
      }

      const selectedService = document.querySelector('.service-option.selected');
      if (!selectedService) {
        alert('Please select a service.');
        return;
      }

      const appointmentDate = document.getElementById('appointmentDate').value;
      const appointmentTime = document.getElementById('appointmentTime').value;
      
      if (!appointmentDate || !appointmentTime) {
        alert('Please select both date and time for your appointment.');
        return;
      }

      // Validate date is not in the past
      const selectedDate = new Date(appointmentDate + 'T00:00:00');
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      if (selectedDate < today) {
        alert('Please select a date that is not in the past.');
        return;
      }

      const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
      if (!paymentMethod) {
        alert('Please select a payment method.');
        return;
      }

      // Disable submit button to prevent double submission
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Booking Appointment...';

      const payload = {
        // Use canonical service code expected by backend (matches services.code)
        service: selectedService.getAttribute('data-service'),
        service_name: selectedService.querySelector('h5').textContent,
        appointment_date: appointmentDate,
        appointment_time: appointmentTime,
        urgency: 'routine', // Default urgency
        notes: document.getElementById('notes').value || '',
        payment_method: paymentMethod
      };

      try {
        const res = await DentalAPI.createAppointment(payload);
        if (res?.success) {
          alert('Thank you! Your appointment has been booked successfully. You will receive a confirmation email shortly.');

          // Refresh the page to clear all form data
          window.location.reload();
          return; // Exit early since page is refreshing
        } else {
          alert(res?.message || 'Failed to book appointment. Please try again.');
        }
      } catch (err) {
        console.error('Appointment booking error:', err);
        if (err && err.message && err.message.includes('401')) {
          alert('Your session expired. Please login again in Patient Portal, then try booking.');
          if (window.DentalFrontend) {
            DentalFrontend.logout();
            DentalFrontend.requireAuth('appointment.html');
          }
        } else if (err && err.message && err.message.includes('time slot is already booked')) {
          alert('This time slot is already booked. Please select a different date or time.');
        } else {
          alert(err?.message || 'Failed to book appointment. Please check your connection and try again.');
        }
      } finally {
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
      }
    });

    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('appointmentDate');
    if (dateInput) {
      dateInput.min = today;
      dateInput.addEventListener('change', function() {
        const selectedDate = new Date(this.value + 'T00:00:00');
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        if (selectedDate < today) {
          alert('Please select a date that is not in the past.');
          this.value = today.toISOString().split('T')[0];
        }
      });
    }
  </script>
</body>
</html>
